<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
</head>
<body>
<h2>Login</h2>
<form id="loginForm">
  <label for="username">Email:</label>
  <input type="text" id="username" name="username" required><br><br>

  <label for="password">Password:</label>
  <input type="password" id="password" name="password" required><br><br>

  <button type="submit">Login</button>
</form>

<!-- Botón para redirigir al registro -->
<form th:action="@{/auth/register}" method="get">
  <button type="submit">Registrarse</button>
</form>

<script>
  // Manejo del formulario de login
  document.getElementById("loginForm").addEventListener("submit", async function(event) {
      event.preventDefault();

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      // Validar campos antes de enviar
      if (!username || !password) {
          alert("Por favor, completa todos los campos.");
          return;
      }

      // Crear el objeto de la solicitud
      const authRequest = {
          username: username,
          password: password
      };

      try {
          // Enviar la solicitud POST al backend
          const response = await fetch("http://localhost:8080/auth/generateToken", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json"
              },
              body: JSON.stringify(authRequest)
          });

          // Verificar el código de estado
          if (!response.ok) {
              throw new Error(`Error en el servidor: ${response.status} ${response.statusText}`);
          }


          // Parsear la respuesta como JSON
          const data = await response.text();

          console.log(data)

          // Verificar si el token está presente
          if (data) {
              // Guardar el token en localStorage
              localStorage.setItem("jwtToken", data);
              alert("Login exitoso!");
              window.location.href = "/home"
          } else {
              alert("Usuario o contraseña incorrectos");
          }
      } catch (error) {
          console.error("Error en el login:", error);
          alert("Ocurrió un error durante el login. Por favor, intenta de nuevo.");
      }
  });
</script>

</body>
</html>